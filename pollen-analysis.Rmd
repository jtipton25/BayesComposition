---
title: "Dirichlet Multinomial Model"
author: "John Tipton"
date: "May 7, 2016"
output: html_document  
---

```{r setup, tidy=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=6, include=FALSE, eval=TRUE}
library(mvnfast)
library(ggplot2)
library(ggmcmc)
library(Matrix)
library(fields)
library(MCMCpack)
library(coda)
library(nimble)
library(snowfall)
library(mcmcplots)
library(data.table)
library(DirichletReg)
library(randomForest)
library(xtable)
library(gridExtra)
library(knitr)
library(here)
library(plyr)
library(BayesComposition)
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)


##
## source functions used in the code below
##

## simulate the cholesky of the correlation matrix
source(here::here("functions", "make-lkj.R"))

## simulate the correlation matrix
source(here::here("functions", "make-correlation-matrix.R"))

## layout multiple ggplot objects in one plot
source(here::here("functions", "multiplot.R"))

## load function to convert MCMC output to CODA object for diagnostics
source(here::here("functions", "convert-to-coda.R"))

## load Gelman-Rubin diagnostic for lack of convergence
source(here::here("functions", "make_gelman_rubin.R"))

## load CRPS function
Rcpp::sourceCpp(here::here("functions", "makeCRPS.cpp"))

##
## Setup MCMC parameters
##

n_adapt <- 15000#0
n_mcmc <- 15000#0
n_thin <- 15#0
n_chains <- 4
## B-spline degrees of freedom parameter
df <- 6
n_save <- n_mcmc / n_thin
n_samples <- n_chains * n_save
## Output MCMC progress modlulo every 'message' iterations
message <- 1000

## currently can choose exponential or gaussian covariance function
corr_function <- "gaussian"
```

# Load Pollen Data and R code
```{r readData, echo=FALSE, include=FALSE, eval=TRUE, results='hide'}
dat <- read.csv(here::here("data", "Reduced.Taxa.calibration.3.23.17.csv"), 
                stringsAsFactors=FALSE, header=TRUE)
N <- length(dat$ACERX[-1])
d <- 16
y <- matrix(c(as.numeric(dat$ACERX[-1]), as.numeric(dat$BETULA[-1]), 
            as.numeric(dat$Sum.Other.Conifer[-1]), as.numeric(dat$LARIXPSEU[-1]), 
            as.numeric(dat$Sum.Other.Deciduous[-1]), as.numeric(dat$FAGUS[-1]), 
            as.numeric(dat$FRAXINUX[-1]), as.numeric(dat$Sum.Other.Herbaceous[-1]), 
            as.numeric(dat$Sum.Prairie.Herbs[-1]), as.numeric(dat$Other[-1]), 
            as.numeric(dat$PICEAX[-1]), as.numeric(dat$PINUSX[-1]), 
            as.numeric(dat$QUERCUS[-1]), as.numeric(dat$TILIA[-1]), 
            as.numeric(dat$TSUGAX[-1]), as.numeric(dat$ULMUS[-1])), N, d)

## Adjust for half counts
y <- ceiling(y)
colnames(y) <- names(dat)[5:20]

X_annual <- as.numeric(dat$tmean_annual[-1])
X <- as.numeric(dat$tmean_07[-1])

## transform the data to percentages for use in transfer function models
y_prop <- y
for (i in 1:N) {
  y_prop[i, ] <- y_prop[i, ] / sum(y_prop[i, ])
}
```


```{r}
pollenPlotData <- data.frame(species=as.factor(rep(colnames(y), each=N)),
                              count=c(as.matrix(y_prop)), 
                              temp=rep(X, times=d))

# png(file=here::here("figures", "pollen-plot.png"), width=18, height=9,
#     units="in", res=100)
ggplot(pollenPlotData, aes(x=temp, y=count, color=species, group=species)) +
  geom_point(alpha=0.25) + 
  theme(legend.position="none") + ggtitle("Pollen Composition vs. July Temperature") +
  labs(x="July Temperature", y="Composition") +
  theme(plot.title=element_text(size=40, face="bold", hjust=0.5)) + 
  theme(axis.text.x = element_text(size = 22), 
        axis.text.y = element_text(size = 22),
        axis.title.x = element_text(size = 22), 
        axis.title.y = element_text(size = 22))
# dev.off()
# include_graphics(here::here("figures", "pollen-plot.png"))
```



```{r}
n_knots <- 30
N_pred <- 25
y <- as.matrix(y)
mean_X <- mean(X)
sd_X <- sd(X)
X <- (X - mean_X) / sd_X
X_knots <- seq(min(X, na.rm=TRUE)-1.25*sd(X, na.rm=TRUE), 
               max(X, na.rm=TRUE)+1.25*sd(X, na.rm=TRUE), length=n_knots)
```



## Held out for prediction
This model took 1.93 hours running 4 mcmc chains in parallel on a 2017 iMac with 4.2GHz processor.

```{r fit-pollen, echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
if (file.exists(here::here("mvgp-test", "fit-pollen-mix.RData"))) {
  ## Load MCMC run
  load(here::here("mvgp-test", "fit-pollen-mix.RData"))
} else {
  ##    
  ## Long running MCMC
  ##

  ## Define parameters 
  params <- list(n_adapt=n_adapt, n_mcmc=n_mcmc, n_thin=n_thin,
                 X_knots=X_knots, message=message)

  parallelChains <- function (n_chains) {
    Rcpp::sourceCpp(here::here("src", "mcmc-dm-basis-mixture.cpp"))
    out <- coda::mcmc(mcmcRcppDMBasisMixture(y, X, params, n_chain=n_chains, 
                               file_name=here::here("mvgp-test", "progress",
                                              "fit-mix.txt")))
  }
  
  ## Initalize multicore
  sfInit(parallel=TRUE, cpus=4)
  sfClusterSetupRNG()
  sfExport("y", "X", "params", "N")
  sfLibrary(coda)
  sfLibrary(here)
  
  ## create temporary progress file  
  file.create(here::here("mvgp-test", "progress", "fit-mix.txt"))
  start <- Sys.time()
  sink(here::here("mvgp-test", "progress", "fit-mix.txt"))
  print(paste("MCMC started at", start))
  sink()
  
  ## run MCMC
  out <- sfLapply(1:4, parallelChains)
  
    ## end timing
  sink(here::here("mvgp-test", "progress", "fit-mix.txt"), append = TRUE)
  print(Sys.time() - start)
  sink()

  ## stop the computing cluster
  sfStop()
    
  save(out, sample_idx, file=here::here("mvgp-test", "fit-pollen-mix.RData"))
}
```


```{r, eval=TRUE}
## initialze posterior sample variables
beta1_post <- array(0, dim=c(n_samples, df, d))
beta2_post <- array(0, dim=c(n_samples, df, d))
alpha1_post <-  array(0, dim=c(n_samples, N, d))
alpha2_post <-  array(0, dim=c(n_samples, N, d))
z_post <- matrix(0, n_samples, N)

for(i in 1:n_chains){
  beta1_post[1:n_save + (i-1)*n_save, , ] <- out[[i]]$beta1
  beta2_post[1:n_save + (i-1)*n_save, , ] <- out[[i]]$beta2
  alpha1_post[1:n_save + (i-1)*n_save, , ] <- out[[i]]$alpha1
  alpha2_post[1:n_save + (i-1)*n_save, , ] <- out[[i]]$alpha2
  z_post[1:n_save + (i-1)*n_save , ] <- out[[i]]$z
}          
```



<!-- ```{r, eval=TRUE} -->
<!-- out <- convert_to_coda(out) -->
<!-- ``` -->



```{r, eval=TRUE}
Rhat <- make_gelman_rubin(out)
layout(matrix(1:9, 3, 3))
hist(Rhat[grepl("beta1", names(Rhat))], main = "Rhat for beta1")
hist(Rhat[grepl("beta2", names(Rhat))], main = "Rhat for beta2")
hist(Rhat[grepl("alpha1", names(Rhat))], main = "Rhat for alpha1")
hist(Rhat[grepl("alpha2", names(Rhat))], main = "Rhat for alpha2")
hist(Rhat[grepl("z", names(Rhat))], main = "Rhat for z")
hist(Rhat, main="All parameters")
max(unlist(na.omit(Rhat)))
```



```{r, eval=TRUE}
## 
## Posterior plots
##

layout(matrix(1:9, 3, 3))
matplot(beta1_post[, , 1], type = 'l')
matplot(beta1_post[, , 2], type = 'l')
matplot(beta1_post[, , 3], type = 'l')
matplot(beta1_post[, , 4], type = 'l')
matplot(beta2_post[, , 1], type = 'l')
matplot(beta2_post[, , 2], type = 'l')
matplot(beta2_post[, , 3], type = 'l')
matplot(beta2_post[, , 4], type = 'l')
```


```{r}
layout(matrix(1:9, 3, 3))
matplot(alpha1_post[, 1, ], type = 'l')
matplot(alpha1_post[, 2, ], type = 'l')
matplot(alpha1_post[, 3, ], type = 'l')
matplot(alpha1_post[, 4, ], type = 'l')
matplot(alpha2_post[, 1, ], type = 'l')
matplot(alpha2_post[, 2, ], type = 'l')
matplot(alpha2_post[, 3, ], type = 'l')
matplot(alpha2_post[, 4, ], type = 'l')
```

```{r}
layout(matrix(1:9, 3, 3))
matplot(z_post[, 1], type='l')
matplot(z_post[, 2], type='l')
matplot(z_post[, 3], type='l')
matplot(z_post[, 4], type='l')
matplot(z_post[, 5], type='l')
matplot(z_post[, 6], type='l')
matplot(z_post[, 7], type='l')
matplot(z_post[, 8], type='l')
matplot(z_post[, 9], type='l')
```


## Might need to sort based on the z values...

```{r}
library(label.switching)

B <- 2

pp <- array(0, dim=c(n_samples, N, B))
# zz <- matrix(0, n_samples, NN)
for (k in 1:n_samples) {
  if (k %% 500 == 0) {
    message("Sample ", k, " out of ", n_samples)
  }
  for (i in 1:N) {
    tmp <- rep(0, 2)
    tmp[1] <- LL_DM_row(alpha1_post[k, i, ], y[i, ], d, sum(y[i, ]))
    tmp[2] <- LL_DM_row(alpha2_post[k, i, ], y[i, ], d, sum(y[i, ]))
    pp[k, i, ] <- tmp / sum(tmp)
    # zz[k, i] <- which(rmultinom(1, 1, tmp) == 1)
  }
}


lab_idx <- label.switching(method="STEPHENS", p=pp, K=B, z=z_post+1)
```



```{r}
alpha1_ordered <-  array(0, dim=c(n_samples, N, d))
alpha2_ordered <-  array(0, dim=c(n_samples, N, d))
z_ordered <- matrix(0, n_samples, N)

for (k in 1:n_samples) {
  if (all(lab_idx$permutations$STEPHENS[k, ] == c(1, 2))) {
    beta1_ordered[k, , ] <- beta1_post[k, , ]
    beta2_ordered[k, , ] <- beta2_post[k, , ]
    alpha1_ordered[k, , ] <- alpha1_post[k, , ]
    alpha2_ordered[k, , ] <- alpha2_post[k, , ]
    z_ordered[k, ] <- z_post[k, ]
  } else {
    beta1_ordered[k, , ] <- beta2_post[k, , ]
    beta2_ordered[k, , ] <- beta1_post[k, , ]
    alpha1_ordered[k, , ] <- alpha2_post[k, , ]
    alpha2_ordered[k, , ] <- alpha1_post[k, , ]
    z_ordered[k, ] <- 1 - z_post[k, ]
  }
}
```



```{r, eval=TRUE}
## 
## Sorted Posterior plots
##

layout(matrix(1:9, 3, 3))
matplot(beta1_ordered[, , 1], type = 'l')
matplot(beta1_ordered[, , 2], type = 'l')
matplot(beta1_ordered[, , 3], type = 'l')
matplot(beta1_ordered[, , 4], type = 'l')
matplot(beta2_ordered[, , 1], type = 'l')
matplot(beta2_ordered[, , 2], type = 'l')
matplot(beta2_ordered[, , 3], type = 'l')
matplot(beta2_ordered[, , 4], type = 'l')
```


```{r}
layout(matrix(1:8, 4, 2))
matplot(alpha1_ordered[, 1, ], type = 'l')
matplot(alpha1_ordered[, 2, ], type = 'l')
matplot(alpha1_ordered[, 3, ], type = 'l')
matplot(alpha1_ordered[, 4, ], type = 'l')
matplot(alpha2_ordered[, 1, ], type = 'l')
matplot(alpha2_ordered[, 2, ], type = 'l')
matplot(alpha2_ordered[, 3, ], type = 'l')
matplot(alpha2_ordered[, 4, ], type = 'l')
```

```{r}
layout(matrix(1:9, 3, 3))
matplot(z_ordered[, 1], type='l')
matplot(z_ordered[, 2], type='l')
matplot(z_ordered[, 3], type='l')
matplot(z_ordered[, 4], type='l')
matplot(z_ordered[, 5], type='l')
matplot(z_ordered[, 6], type='l')
matplot(z_ordered[, 7], type='l')
matplot(z_ordered[, 8], type='l')
matplot(z_ordered[, 9], type='l')
```


```{r}
alpha1_post_mean <- apply(alpha1_ordered, c(2, 3), mean)
alpha2_post_mean <- apply(alpha2_ordered, c(2, 3), mean)
alpha1_post_sum_to_one <- alpha1_ordered
alpha2_post_sum_to_one <- alpha2_ordered
for (k in 1:n_samples) {
  for (i in 1:N) {
    alpha1_post_sum_to_one[k, i, ] <- alpha1_post_sum_to_one[k, i, ] /
        sum(alpha1_post_sum_to_one[k, i, ])
    alpha2_post_sum_to_one[k, i, ] <- alpha2_post_sum_to_one[k, i, ] /
        sum(alpha2_post_sum_to_one[k, i, ])
  }
}
alpha1_post_lower_95 <- apply(alpha1_post_sum_to_one, c(2, 3), quantile, prob=0.025)
alpha2_post_lower_95 <- apply(alpha2_post_sum_to_one, c(2, 3), quantile, prob=0.025)
alpha1_post_upper_95 <- apply(alpha1_post_sum_to_one, c(2, 3), quantile, prob=0.975)
alpha2_post_upper_95 <- apply(alpha2_post_sum_to_one, c(2, 3), quantile, prob=0.975)

p_alpha1 <- apply(alpha1_post_sum_to_one, c(2, 3), mean)
p_alpha2 <- apply(alpha2_post_sum_to_one, c(2, 3), mean)

y_prop <- y
for (i in 1:N) {
  y_prop[i, ] <- y[i, ] / sum(y[i, ])
}

species_names <- c("ACERX", "BETULA", "Conifer", "LARIXPSEU", 
                   "Deciduous", "FAGUS", "FRAXINUX",
                   "Herbaceous", "Prairie Herbs", "Other",
                   "PICEAX", "PINUSX", "QUERCUS", "TILIA", "TSUGAX",
                   "ULMUS")
fitPlotData <- data.frame(
  species      = factor(rep(colnames(y), each=N),
                        levels=colnames(y)), 
  count        = c(y_prop), 
  depth        = rep(X*sd_X + mean_X, times=d),
  alpha1        = c(p_alpha1), 
  alpha1_lower  = c(alpha1_post_lower_95), 
  alpha1_upper  = c(alpha1_post_upper_95),
  alpha2        = c(p_alpha2), 
  alpha2_lower  = c(alpha2_post_lower_95), 
  alpha2_upper  = c(alpha2_post_upper_95), 
  z             = c(matrix(apply(z_ordered, 2, mean), N, d)))
fitPlotData$species <- revalue(fitPlotData$species, 
                               c("Sum.Other.Deciduous"= "DECIDUOUS",
                                 "Sum.Other.Herbaceous"= "OTHER HERBS",
                                 "Sum.Prairie.Herbs"= "PRAIRIE HERBS", 
                                 "Sum.Other.Conifer"= "OTHER CONIFER"))

# fitPlotData <- data.frame(species=as.factor(rep(species_names, each=N-N_pred)), 
#                           count=c(y_prop[-sample_idx, ]), 
#                           depth=rep(X[-sample_idx]*sd_X + mean_X, times=d),
#                           alpha=c(p_alpha), 
#                           alpha_lower=c(alpha_post_lower_95), 
#                           alpha_upper=c(alpha_post_upper_95))

g11_post <- ggplot(fitPlotData, aes(x=depth, y=count, color=species, group=species)) + 
  geom_point(aes(alpha=1-z)) + theme(legend.position="none") +
  geom_ribbon(aes(ymin=alpha1_lower, ymax=alpha1_upper, fill=species, group=species),
              linetype=0, alpha=0.5) + 
  ggtitle("Composition vs. July Tempertaure") + 
  theme(plot.title=element_text(size=20, face="bold")) + 
  geom_line(aes(x=depth, y=alpha1, col = species), fitPlotData, lwd=1.25) + 
  labs(x="July Temperature", y="Composition", size=20)
g12_post <- ggplot(fitPlotData, aes(x=depth, y=count, color=species, group=species)) + 
  geom_point(aes(alpha = z)) + theme(legend.position="none") +
  geom_ribbon(aes(ymin=alpha2_lower, ymax=alpha2_upper, fill=species, group=species),
              linetype=0, alpha=0.5) + 
  ggtitle("Composition vs. July Tempertaure") + 
  theme(plot.title=element_text(size=20, face="bold")) + 
  geom_line(aes(x=depth, y=alpha2, col = species), fitPlotData, lwd=1.25) + 
  labs(x="July Temperature", y="Composition", size=20)

g21_post <- ggplot(fitPlotData, aes(x=depth, y=count, color=species,
                                    group=species, alpha=z)) + 
  geom_point(aes(alpha = 1-z)) + theme(legend.position="none") +  
  geom_ribbon(aes(ymin=alpha1_lower, ymax=alpha1_upper,
                  fill=species, group=species),
              linetype=0, alpha=0.5) + 
  ggtitle("Composition vs. July Temperature") + 
  theme(plot.title=element_text(size=40, face="bold", hjust=0.5)) + 
  geom_line(aes(x=depth, y=alpha1, col = species), fitPlotData, lwd=1.25) + 
  facet_wrap( ~ species, ncol = 4) + 
  labs(x="July Temperature", y="Composition") + 
  # theme(strip.text.x = element_text(size = 30),
  #       axis.text.x = element_text(size = 34), 
  #       axis.text.y = element_text(size = 34),
  #       axis.title.x = element_text(size = 34), 
  #       axis.title.y = element_text(size = 34)) + 
  scale_y_continuous(breaks=c(0.0, 0.33, 0.66, 1.0)) + 
  scale_x_continuous(breaks=c(18, 20, 22, 24))
g22_post <- ggplot(fitPlotData, aes(x=depth, y=count, color=species, 
                                    group=species, alpha = 1-z)) + 
  geom_point(aes(alpha = z)) + theme(legend.position="none") +  
  geom_ribbon(aes(ymin=alpha2_lower, ymax=alpha2_upper, 
                  fill=species, group=species),
              linetype=0, alpha=0.5) + 
  ggtitle("Composition vs. July Temperature") + 
  theme(plot.title=element_text(size=40, face="bold", hjust=0.5)) + 
  geom_line(aes(x=depth, y=alpha2, col = species), fitPlotData, lwd=1.25) + 
  facet_wrap( ~ species, ncol = 4) + 
  labs(x="July Temperature", y="Composition") + 
  # theme(strip.text.x = element_text(size = 30),
  #       axis.text.x = element_text(size = 34), 
  #       axis.text.y = element_text(size = 34),
  #       axis.title.x = element_text(size = 34), 
  #       axis.title.y = element_text(size = 34)) + 
  scale_y_continuous(breaks=c(0.0, 0.33, 0.66, 1.0)) + 
  scale_x_continuous(breaks=c(18, 20, 22, 24))

# png(file=here::here("pollen-mix.png"), width=16*2, height=9*2,
#     units="in", res=100)
multiplot(g11_post, g12_post, g21_post, g22_post, cols=2)
# dev.off()

# include_graphics(here::here("figures", "pollen-fit.png"))
```


<!-- ```{r} -->
<!-- library(grid) -->
<!-- library(gtable) -->
<!-- g <- ggplotGrob(g2_post) -->
<!-- pos =  c(subset(g$layout, grepl("panel", g$layout$name), select = t)) -->
<!-- for(i in pos) g$heights[i-1] = unit(1.4,"cm") -->

<!-- # The grobs that need their heights changed: -->
<!-- grobs = which(grepl("strip", g$layout$name)) -->
<!-- for(i in grobs) g$grobs[[i]]$heights <-  unit(1, "npc")       -->
<!-- grid.newpage() -->
<!-- grid.draw(g) -->

<!-- png(file=here::here("figures", "pollen-fit2.png"), width=18, height=9, -->
<!--     units="in", res=100) -->
<!-- grid.draw(g) -->
<!-- g -->
<!-- dev.off() -->
<!-- include_graphics(here::here("figures", "pollen-fit2.png")) -->
<!-- ``` -->


